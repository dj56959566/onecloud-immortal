name: Build OneCloud ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      kernel_update:
        description: "æ˜¯å¦ä½¿ç”¨æœ€æ–°ç‰ˆå†…æ ¸ï¼Ÿ(yes/no)"
        required: false
        default: "no"
  schedule:
    - cron: "0 16 * * *"   # æ¯å¤©åŒ—äº¬æ—¶é—´ 00:00ï¼ˆUTC+8ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl unzip build-essential ccache
          echo "âœ… æ„å»ºç¯å¢ƒå·²åˆå§‹åŒ–"

      - name: Clone ImmortalWrt Source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom diy.sh
        run: |
          chmod +x scripts/diy.sh
          ./scripts/diy.sh

      - name: Use seed config safely
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          if [ -f "$GITHUB_WORKSPACE/config/seed.config" ]; then
            echo "âœ… æ‰¾åˆ° seed.config äºä»“åº“æ ¹ç›®å½•"
            cp "$GITHUB_WORKSPACE/config/seed.config" openwrt/.config
          elif [ -f "config/seed.config" ]; then
            echo "âœ… æ‰¾åˆ° seed.config äºå½“å‰ç›®å½•"
            cp "config/seed.config" openwrt/.config
          else
            echo "âš ï¸ æœªæ‰¾åˆ° seed.configï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: Update Kernel (optional)
        if: ${{ github.event.inputs.kernel_update == 'yes' }}
        run: |
          cd openwrt
          echo "ğŸ” æ‰‹åŠ¨æ›´æ–°å†…æ ¸ä¸­..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: Build Firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Package Firmware
        run: |
          cd openwrt/bin/targets/*/*
          mkdir -p $GITHUB_WORKSPACE/output
          echo "ğŸ“¦ æ‰“åŒ…çº¿åˆ·ç‰ˆä¸Uç›˜ç‰ˆå›ºä»¶..."
          zip -r $GITHUB_WORKSPACE/output/OneCloud_ImmortalWrt_Line.zip *factory*.bin || true
          zip -r $GITHUB_WORKSPACE/output/OneCloud_ImmortalWrt_USB.zip *sysupgrade*.bin || true
          echo "âœ… æ‰“åŒ…å®Œæˆ"

      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "OneCloud ImmortalWrt è‡ªåŠ¨æ„å»ºç‰ˆ"
          body: |
            ### å›ºä»¶è¯´æ˜
            - çº¿åˆ·ç‰ˆï¼šç”¨äº USB ç›´åˆ·æˆ–åˆæ¬¡å®‰è£…
            - Uç›˜ç‰ˆï¼šç”¨äºå‡çº§æˆ–å¤–æ¥å¯åŠ¨
            - æ¯æ—¥è‡ªåŠ¨æ„å»ºåŒ—äº¬æ—¶é—´ 00:00
          files: |
            output/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
