name: Build OneCloud ImmortalWrt ARMv7

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚ 6.6 / 6.12 / 6.13 / latestï¼‰"
        required: false
        default: "6.6"
  schedule:
    - cron: '0 16 * * *' # æ¯æ—¥ UTC 16:00 â†’ åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æž„å»º

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  REPO_BRANCH: master
  TARGET_SUBTARGET: generic
  TARGET_PROFILE: ONECLOUD_PROFILE
  NUM_JOBS: 2

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ git python3 rsync unzip zstd qemu-utils binutils bzip2 kmod parted kpartx
          df -h

      - name: Clone ImmortalWrt source
        run: |
          git clone --depth=1 -b ${REPO_BRANCH} ${REPO_URL} openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Copy custom config/scripts
        run: |
          mkdir -p openwrt/custom
          cp -r $GITHUB_WORKSPACE/config openwrt/custom/config || true
          cp -r $GITHUB_WORKSPACE/scripts openwrt/custom/scripts || true

      - name: Apply DIY customizations
        run: |
          cd openwrt
          chmod +x custom/scripts/diy.sh
          custom/scripts/diy.sh

      - name: Set kernel version dynamically
        run: |
          cd openwrt
          KERNEL_VER="${{ github.event.inputs.kernel_version || '6.6' }}"
          echo "ðŸ§© ä½¿ç”¨å†…æ ¸ç‰ˆæœ¬: $KERNEL_VER"
          if grep -q "CONFIG_KERNEL_PATCHVER" custom/config/seed.config; then
            sed -i "s/CONFIG_KERNEL_PATCHVER=.*/CONFIG_KERNEL_PATCHVER=\"$KERNEL_VER\"/" custom/config/seed.config
          else
            echo "CONFIG_KERNEL_PATCHVER=\"$KERNEL_VER\"" >> custom/config/seed.config
          fi

      - name: Use seed config safely
        run: |
          cd openwrt
          if [ -f custom/config/seed.config ]; then
            cp custom/config/seed.config .config
          else
            echo "âš ï¸ æœªæ‰¾åˆ° seed.configï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: Download sources
        run: |
          cd openwrt
          make download -j1 V=s

      - name: Build firmware
        run: |
          cd openwrt
          make -j${{ env.NUM_JOBS }} V=s || (cat build_dir/*/build.log || true; exit 1)

      - name: Package sysupgrade (çº¿åˆ·ç‰ˆ)
        if: always()
        run: |
          cd openwrt/bin/targets
          mkdir -p ../../publish/sysupgrade
          find . -type f -name "*sysupgrade*.bin" -exec cp {} ../../publish/sysupgrade/ \;
          cd ../../publish/sysupgrade
          sha256sum * > sha256sums.txt || true
          echo "OneCloud ImmortalWrt çº¿åˆ·ç‰ˆ" > README-çº¿åˆ·ç‰ˆ.txt
          echo "é€‚ç”¨ï¼šè®¾å¤‡ä¸Š sysupgrade æ–¹å¼åˆ·å…¥" >> README-çº¿åˆ·ç‰ˆ.txt
          zip -r ../OneCloud-ImmortalWrt-Sysupgrade.zip .

      - name: Package USB (Uç›˜ç‰ˆ)
        if: always()
        run: |
          cd openwrt/bin/targets
          mkdir -p ../../publish/usb
          find . -type f -name "*ext4*.img*" -exec cp {} ../../publish/usb/ \;
          cd ../../publish/usb
          sha256sum * > sha256sums.txt || true
          echo "OneCloud ImmortalWrt Uç›˜ç‰ˆ" > README-Uç›˜ç‰ˆ.txt
          echo "é€‚ç”¨ï¼šddå†™å…¥Uç›˜åŽå¯åŠ¨" >> README-Uç›˜ç‰ˆ.txt
          zip -r ../OneCloud-ImmortalWrt-USB.zip .

      - name: Collect logs
        if: always()
        run: |
          mkdir -p openwrt/publish/log
          cp -v openwrt/build_dir/*/config.log openwrt/publish/log/ 2>/dev/null || true
          echo "æž„å»ºæ—¥å¿—å¯åœ¨ Actions æŸ¥çœ‹" > openwrt/publish/log/README.txt

      - name: Delete older releases (keep latest)
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: OneCloud-ImmortalWrt-${{ github.run_number }}
          files: |
            openwrt/publish/OneCloud-ImmortalWrt-Sysupgrade.zip
            openwrt/publish/OneCloud-ImmortalWrt-USB.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onecloud-artifacts
          path: openwrt/publish/
