name: Build OneCloud ImmortalWrt (Extreme Space Optimized)

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯æ—¥åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æ„å»º
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'é€‰æ‹©å†…æ ¸ç‰ˆæœ¬ï¼ˆé»˜è®¤ 6.6 LTSï¼‰'
        required: true
        default: '6.6'
        type: choice
        options:
          - 5.15
          - 6.6
          - 6.10
          - 6.12
          - 6.13

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      START_TIME: ${{ github.run_started_at }}

    steps:
      - name: ğŸ§¹ Full Advanced Cleanup (Free up >20GB)
        run: |
          echo "ğŸš§ Cleaning runner environment to maximize space..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo rm -rf /tmp/* || true
          echo "âœ… After cleanup:"
          df -h /

      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set kernel version
        run: |
          echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version }}" >> $GITHUB_ENV
          echo "Kernel version set to $KERNEL_VERSION"

      - name: ğŸ§° Install essential dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc g++ git wget curl unzip \
            python3 zstd rsync libncurses5-dev gawk gettext \
            libssl-dev xsltproc file bzip2 ccache
          df -h /

      - name: ğŸ§ª Check free space before build
        run: |
          echo "Checking available disk space..."
          df -h /
          avail=$(df / | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ "${avail%.*}" -lt 5 ]; then
            echo "âŒ Not enough space (<5G free). Exiting."
            exit 1
          fi

      - name: ğŸ—„ï¸ Setup tmpfs build directory (8G RAM)
        run: |
          echo "ğŸ§© Mounting tmpfs (8G) for build workspace..."
          sudo mkdir -p /mnt/workspace
          sudo mountpoint -q /mnt/workspace || sudo mount -t tmpfs -o size=8G tmpfs /mnt/workspace
          mkdir -p /mnt/workspace/openwrt
          echo "WORKDIR=/mnt/workspace/openwrt" >> $GITHUB_ENV
          df -h /mnt/workspace

      - name: ğŸ“¥ Clone ImmortalWrt source
        run: |
          cd /mnt/workspace
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ§© Apply config and custom diy.sh
        run: |
          cd /mnt/workspace/openwrt
          cp $GITHUB_WORKSPACE/config/seed.config .config
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          $GITHUB_WORKSPACE/scripts/diy.sh || true

      - name: ğŸ§ª Check free space before compile
        run: |
          df -h /
          avail=$(df / | tail -1 | awk '{print $4}' | sed 's/G//')
          if [ "${avail%.*}" -lt 5 ]; then
            echo "âŒ Not enough space (<5G free). Exiting."
            exit 1
          fi

      - name: ğŸš€ Build firmware
        run: |
          cd /mnt/workspace/openwrt
          echo "Using KERNEL_VERSION=$KERNEL_VERSION"
          make defconfig
          make -j$(nproc) || make -j1 V=s

      - name: ğŸ“¦ Package firmware and generate release notes
        run: |
          mkdir -p release
          cp -r /mnt/workspace/openwrt/bin/targets/*/*/* release/ || true
          cd release

          END_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          BUILD_TIME=$(( ($(date -d "$END_TIME" +%s) - $(date -d "${{ env.START_TIME }}" +%s)) / 60 ))

          echo "OneCloud ImmortalWrt è‡ªåŠ¨æ„å»ºå®Œæˆ" > release_notes.txt
          echo "æ„å»ºæ—¶é—´: $END_TIME" >> release_notes.txt
          echo "æ„å»ºè€—æ—¶: ${BUILD_TIME} åˆ†é’Ÿ" >> release_notes.txt
          echo "å†…æ ¸ç‰ˆæœ¬: $KERNEL_VERSION" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "æ–‡ä»¶åˆ—è¡¨ï¼š" >> release_notes.txt
          ls -lah >> release_notes.txt || true

          sha256sum * > checksum.sha256 || true

          SYSUPGRADE=$(ls *sysupgrade.bin 2>/dev/null | head -n1 || true)
          SDCARD=$(ls *sdcard.img.gz 2>/dev/null | head -n1 || true)

          if [ -n "$SYSUPGRADE" ]; then
            zip -j onecloud-immortal-${KERNEL_VERSION}-sysupgrade.zip "$SYSUPGRADE" checksum.sha256 release_notes.txt || true
          fi
          if [ -n "$SDCARD" ]; then
            zip -j onecloud-immortal-${KERNEL_VERSION}-sdcard.zip "$SDCARD" checksum.sha256 release_notes.txt || true
          fi

          # åˆå¹¶æ€»åŒ…
          zip -r onecloud-immortal-${KERNEL_VERSION}.zip ./*.zip || true

          echo "âœ… æ‰“åŒ…å®Œæˆï¼š"
          ls -lah

      - name: ğŸ§¹ Delete old releases (keep latest 0)
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Publish new release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip
          tag_name: nightly
          name: "OneCloud ImmortalWrt è‡ªåŠ¨æ„å»º - Kernel ${{ github.event.inputs.kernel_version }}"
          body_path: release/release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: â™»ï¸ Cleanup & unmount tmpfs
        if: always()
        run: |
          echo "ğŸ§¹ Unmounting tmpfs build directory..."
          sudo umount /mnt/workspace || true
          sudo rm -rf /mnt/workspace || true
          df -h
          echo "âœ… tmpfs released and workspace cleaned."
