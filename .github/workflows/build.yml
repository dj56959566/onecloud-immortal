name: Build OneCloud ImmortalWrt ARMv7

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "选择内核版本（如 6.6 / 6.12 / 6.13 / latest）"
        required: false
        默认: "6.6"
  schedule:
    - cron: '0 16 * * *' # 每日 UTC 16:00 -> 北京时间 00:00

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  REPO_BRANCH: master
  TARGET_SUBTARGET: generic
  TARGET_PROFILE: ONECLOUD_PROFILE
  NUM_JOBS: 2

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare system
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc g++ git python3 rsync unzip zstd qemu-utils binutils bzip2 kmod parted kpartx
          sudo rm -rf /opt/hostedtoolcache || true
          df -h

      - name: Clone ImmortalWrt
        run: |
          git clone --depth=1 -b ${REPO_BRANCH} ${REPO_URL} openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply DIY customizations
        run: |
          cd openwrt
          cp -r $GITHUB_WORKSPACE/config ./ || true
          cp -r $GITHUB_WORKSPACE/scripts ./ || true
          chmod +x ./scripts/diy.sh
          ./scripts/diy.sh

      - name: Set kernel version dynamically
        run: |
          cd openwrt
          echo "Using kernel version: ${{ github.event.inputs.kernel_version || '6.6' }}"
          sed -i "s/CONFIG_KERNEL_PATCHVER=.*/CONFIG_KERNEL_PATCHVER=\"${{ github.event.inputs.kernel_version || '6.6' }}\"/" ../config/seed.config || true

      - name: Use seed config
        run: |
          cp ../config/seed.config .config

      - name: Build firmware
        run: |
          cd openwrt
          make download -j1
          make -j${{ env.NUM_JOBS }} V=s
