name: Build OneCloud ImmortalWrt

on:
  schedule:
    - cron: '0 16 * * *'   # ÊØèÊó•Âåó‰∫¨Êó∂Èó¥ 00:00 Ëá™Âä®ÊûÑÂª∫
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'ÈÄâÊã©ÂÜÖÊ†∏ÁâàÊú¨ÔºàÈªòËÆ§ 6.6 LTSÔºâ'
        required: true
        default: '6.6'
        type: choice
        options:
          - 5.15
          - 6.6
          - 6.10
          - 6.12
          - 6.13

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TZ: Asia/Shanghai

    steps:
      - name: üßπ Full system cleanup before build
        run: |
          echo "üöß Cleaning runner environment to free space..."
          sudo rm -rf /home/runner/* || true
          sudo docker system prune -af || true
          sudo apt-get clean || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /home/runner/actions-runner/cached || true
          df -h

      - name: üì¶ Checkout repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set kernel version
        run: |
          echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version }}" >> $GITHUB_ENV
          echo "Kernel version set to $KERNEL_VERSION"

      - name: üß∞ Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc g++ git wget curl unzip python3 zstd rsync libncurses5-dev gawk gettext libssl-dev xsltproc file bzip2 ccache

      - name: üóÑÔ∏è Setup tmpfs build directory
        run: |
          sudo mkdir -p /mnt/workspace
          sudo mountpoint -q /mnt/workspace || sudo mount -t tmpfs -o size=8G tmpfs /mnt/workspace
          mkdir -p /mnt/workspace/build
          echo "TMPDIR=/mnt/workspace/build" >> $GITHUB_ENV
          echo "WORKDIR=/mnt/workspace/build" >> $GITHUB_ENV
          df -h /mnt/workspace

      - name: ‚ö° Cache OpenWrt build
        uses: actions/cache@v3
        with:
          path: |
            openwrt/staging_dir
            openwrt/dl
          key: ${{ runner.os }}-openwrt-${{ hashFiles('config/seed.config') }}

      - name: üì• Clone ImmortalWrt source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: üß© Apply seed.config & diy.sh
        run: |
          cd openwrt
          cp ../config/seed.config .config
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh || true

      - name: üöÄ Build firmware
        run: |
          cd openwrt
          echo "Using KERNEL_VERSION=$KERNEL_VERSION"
          make defconfig
          make -j$(nproc) || make -j1 V=s

      - name: üì¶ Package firmware separately (sysupgrade & sdcard)
        run: |
          mkdir -p release
          cp -r openwrt/bin/targets/*/*/* release/ || true
          cd release
          echo "Build Time: $(date '+%Y-%m-%d %H:%M:%S')" > release_notes.txt
          echo "Kernel: $KERNEL_VERSION" >> release_notes.txt
          ls -lah >> release_notes.txt || true
          sha256sum * > checksum.sha256 || true
          SYSUPGRADE=$(ls *sysupgrade.bin 2>/dev/null | head -n1 || true)
          SDCARD=$(ls *sdcard.img.gz 2>/dev/null | head -n1 || true)
          if [ -n "$SYSUPGRADE" ]; then
            zip -j onecloud-immortal-${KERNEL_VERSION}-sysupgrade.zip "$SYSUPGRADE" checksum.sha256 release_notes.txt || true
          fi
          if [ -n "$SDCARD" ]; then
            zip -j onecloud-immortal-${KERNEL_VERSION}-sdcard.zip "$SDCARD" checksum.sha256 release_notes.txt || true
          fi
          ls -lah

      - name: üöÄ Release to GitHub (upload both zips if present)
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip
          tag_name: nightly
          name: "OneCloud ImmortalWrt Ëá™Âä®ÊûÑÂª∫ - Kernel ${{ github.event.inputs.kernel_version }}"
          body_path: release/release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üßπ Clean old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚ôªÔ∏è Unmount tmpfs and cleanup after build
        if: always()
        run: |
          echo "üßπ Unmounting tmpfs build directory..."
          sudo umount /mnt/workspace || true
          sudo rm -rf /mnt/workspace || true
          echo "‚úÖ tmpfs released and workspace cleaned."
          df -h
