name: Build OneCloud ImmortalWrt

on:
  schedule:
    - cron: '0 16 * * *'   # æ¯æ—¥åŒ—äº¬æ—¶é—´ 00:00
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'å¯é€‰ï¼šè¦†ç›–é»˜è®¤å†…æ ¸ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ 6.6ï¼‰'
        required: false
        default: '6.6'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
      # 1ï¸âƒ£ æ¸…ç† runner ç£ç›˜ç©ºé—´
      - name: ğŸ§¹ Clean runner cached directories
        run: |
          echo "Cleaning up runner cache and old work dirs..."
          sudo rm -rf /home/runner/actions-runner/cached/_diag/*
          sudo rm -rf /home/runner/actions-runner/_work/*
          df -h

      # 2ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: ğŸ“¦ Checkout repo
        uses: actions/checkout@v4

      # 3ï¸âƒ£ è®¾ç½®å†…æ ¸ç‰ˆæœ¬ï¼ˆå¯æ‰‹åŠ¨è¦†ç›–ï¼‰
      - name: âš ï¸ Set kernel version
        run: |
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            echo "Using kernel override: ${{ github.event.inputs.kernel_version }}"
            echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version }}" >> $GITHUB_ENV
          else
            echo "KERNEL_VERSION=6.6" >> $GITHUB_ENV
          fi
          echo "Kernel version set to $KERNEL_VERSION"

      # 4ï¸âƒ£ å®‰è£…æ„å»ºä¾èµ–
      - name: ğŸ§° Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc g++ git wget curl unzip \
            python3 zstd rsync libncurses5-dev gawk gettext \
            libssl-dev xsltproc file bzip2 ccache

      # 5ï¸âƒ£ ä½¿ç”¨ tmpfs æŒ‚è½½å¤§æ–‡ä»¶ç›®å½•ï¼ˆæå‡ IO å¹¶é¿å…ç£ç›˜ä¸è¶³ï¼‰
      - name: ğŸ—„ï¸ Prepare tmpfs build directory
        run: |
          sudo mkdir -p /mnt/workspace
          sudo mountpoint -q /mnt/workspace || sudo mount -t tmpfs -o size=8G tmpfs /mnt/workspace
          mkdir -p /mnt/workspace/build
          export TMPDIR=/mnt/workspace/build
          echo "TMPDIR=/mnt/workspace/build" >> $GITHUB_ENV
          df -h /mnt/workspace

      # 6ï¸âƒ£ ç¼“å­˜ OpenWrt ç¼–è¯‘ç»“æœï¼ŒåŠ é€Ÿåç»­æ„å»º
      - name: âš¡ Cache OpenWrt build
        uses: actions/cache@v3
        with:
          path: |
            openwrt/staging_dir
            openwrt/bin
          key: ${{ runner.os }}-openwrt-${{ hashFiles('config/seed.config') }}

      # 7ï¸âƒ£ æ‹‰å– ImmortalWrt æºç 
      - name: ğŸ“¥ Clone ImmortalWrt
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 8ï¸âƒ£ åº”ç”¨è‡ªå®šä¹‰é…ç½®ä¸ diy è„šæœ¬
      - name: âš™ï¸ Apply seed.config & diy.sh
        run: |
          cd openwrt
          cp ../config/seed.config .config
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh || true

      # 9ï¸âƒ£ ç¼–è¯‘å›ºä»¶
      - name: ğŸš€ Build firmware
        run: |
          cd openwrt
          echo "Using KERNEL_VERSION=$KERNEL_VERSION"
          make defconfig
          make -j$(nproc) || make -j1 V=s

      # ğŸ”Ÿ æ‰“åŒ… Release
      - name: ğŸ“¦ Package firmware
        run: |
          mkdir -p release
          cp -r openwrt/bin/targets/*/*/* release/ || true
          cd release
          echo "Build Time: $(date '+%Y-%m-%d %H:%M:%S')" > release_notes.txt
          echo "Kernel: $KERNEL_VERSION (default 6.6 LTS)" >> release_notes.txt
          sha256sum * > checksum.sha256 || true
          zip -r onecloud-immortal-$(date +%Y%m%d)-stable.zip ./* || true
          ls -lah

      # 1ï¸âƒ£1ï¸âƒ£ å‘å¸ƒåˆ° GitHub Releases
      - name: ğŸš€ Release to GitHub
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.zip
          tag_name: nightly
          name: "OneCloud ImmortalWrt è‡ªåŠ¨æ„å»º"
          body_path: release/release_notes.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 1ï¸âƒ£2ï¸âƒ£ è‡ªåŠ¨æ¸…ç†æ—§ Releaseï¼Œä»…ä¿ç•™æœ€æ–°
      - name: ğŸ§¹ Clean old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
