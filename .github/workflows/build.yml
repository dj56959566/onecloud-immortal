name: build-onecloud-immortal
on:
  schedule:
    # 每日北京时间 00:00 -> UTC 16:00
    - cron: '0 16 * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  packages: write
  statuses: write

jobs:
  build:
    runs-on: [self-hosted, linux, onecloud-builder]
    env:
      TZ: Asia/Shanghai
      BUILD_KERNEL_VERSION: '6.6'
      TARGET_ARCH: 'arm'
      OUTPUT_DIR: output
      BUILD_DIR: /mnt/build/immortalwrt

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup cache for ccache
        uses: actions/cache@v4
        with:
          path: |
            .ccache
            dl
            build_dir
          key: ${{ runner.os }}-immortal-${{ env.BUILD_KERNEL_VERSION }}-${{ hashFiles('config/seed.config','scripts/diy.sh') }}
          restore-keys: |
            ${{ runner.os }}-immortal-${{ env.BUILD_KERNEL_VERSION }}-

      - name: Show runner disk
        run: df -h || true

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get -y install build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc rsync unzip python3 python3-distutils 

      - name: Clone ImmortalWrt official source
        run: |
          rm -rf immortalwrt
          git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git
          cd immortalwrt
          git checkout master || true

      - name: Prepare build dir on runner
        run: |
          sudo mkdir -p "${{ env.BUILD_DIR }}"
          sudo chown $USER:$USER "${{ env.BUILD_DIR }}"
          mkdir -p "${{ env.OUTPUT_DIR }}"
          df -h "${{ env.BUILD_DIR }}" || true

      - name: Prepare feeds and custom config
        run: |
          cd immortalwrt
          mkdir -p config
          cp ../config/seed.config .

      - name: Apply diy customizations
        run: |
          cd immortalwrt
          chmod +x ../scripts/diy.sh
          ../scripts/diy.sh ${BUILD_KERNEL_VERSION}

      - name: Build firmware
        run: |
          cd immortalwrt
          make -j$(nproc) V=s || (echo 'Build failed — check logs' && exit 1)
        env:
          MAKEFLAGS: -j$(nproc)

      - name: Collect artifacts and pack
        run: |
          cd immortalwrt
          mkdir -p ../${{ env.OUTPUT_DIR }}
          find bin/targets -type f -name '*sysupgrade*.bin' -o -name '*sdcard*.img' -print | while read f; do
            base=$(basename "$f")
            if echo "$base" | grep -i sdcard >/dev/null 2>&1; then
              cp "$f" ../${{ env.OUTPUT_DIR }}/onecloud-immortal-udisk-${base}
            else
              cp "$f" ../${{ env.OUTPUT_DIR }}/onecloud-immortal-flash-${base}
            fi
          done

          cd ../${{ env.OUTPUT_DIR }}
          mkdir -p udbuf flashbuf
          mv *udisk-* udbuf/ 2>/dev/null || true
          mv *flash-* flashbuf/ 2>/dev/null || true
          if [ -d udbuf ] && [ "$(ls -A udbuf)" ]; then
            zip -r onecloud-immortal-udisk.zip udbuf || true
          fi
          if [ -d flashbuf ] && [ "$(ls -A flashbuf)" ]; then
            zip -r onecloud-immortal-flash.zip flashbuf || true
          fi
          zip -r onecloud-immortal.zip *.zip || true

      - name: Create / update release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "build-${{ github.run_id }}"
          name: "onecloud-immortal-${{ github.run_id }}"
          body: |
            自动构建（onecloud-immortal）
            - 内核: ${{ env.BUILD_KERNEL_VERSION }}
            - 平台: OneCloud ARMv7
            - 时间: ${{ github.event.head_commit.timestamp || github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifacts to release
        uses: actions/upload-release-asset@v2
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.OUTPUT_DIR }}/onecloud-immortal.zip
          asset_name: onecloud-immortal.zip
          asset_content_type: application/zip

      - name: Cleanup old releases (only keep latest)
        uses: actions/github-script@v6
        with:
          script: |
            const latest = await github.rest.repos.getLatestRelease({owner: context.repo.owner, repo: context.repo.repo}).catch(e=>null)
            if (latest && latest.data && latest.data.id) {
              const releases = await github.rest.repos.listReleases({owner: context.repo.owner, repo: context.repo.repo})
              for (const r of releases.data) {
                if (r.id !== latest.data.id) {
                  await github.rest.repos.deleteRelease({owner: context.repo.owner, repo: context.repo.repo, release_id: r.id})
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
